rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is a family member
    function isMember(familyId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/families/$(familyId)/members/$(request.auth.uid));
    }

    // Helper function to check if user is an admin
    function isAdmin(familyId) {
      return request.auth != null &&
        get(/databases/$(database)/documents/families/$(familyId)/members/$(request.auth.uid)).data.role == 'admin';
    }

    // Families collection
    match /families/{familyId} {
      // Create: authenticated users can create families (becoming admins)
      allow create: if request.auth != null &&
        request.resource.data.name is string &&
        request.resource.data.members[request.auth.uid].role == 'admin';

      // Read: members can read family
      allow read: if isMember(familyId);

      // Update: only admins can update family name
      allow update: if isAdmin(familyId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name']);

      // Delete: only admins can delete family
      allow delete: if isAdmin(familyId);

      // Members subcollection
      match /members/{uid} {
        // Read: any member of the family
        allow read: if isMember(familyId);
        // Create: only existing admins can add members
        allow create: if isAdmin(familyId) &&
          request.resource.data.role in ['admin', 'viewer'] &&
          request.resource.data.keys().hasOnly(['role', 'displayName', 'addedAt']);
        // Update: only admins can update member roles
        allow update: if isAdmin(familyId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'displayName']);
        // Delete: only admins can remove members (but not themselves if they're the last admin)
        allow delete: if isAdmin(familyId);
      }

      // Babies subcollection
      match /babies/{babyId} {
        // Read: any family member
        allow read: if isMember(familyId);
        // Create: only admins
        allow create: if isAdmin(familyId);
        // Update: only admins
        allow update: if isAdmin(familyId);
        // Delete: only admins
        allow delete: if isAdmin(familyId);

        // Moments subcollection
        match /moments/{momentId} {
          // Read: any family member
          allow read: if isMember(familyId);
          // Create: only admins
          allow create: if isAdmin(familyId) &&
            request.resource.data.mediaObjectKey is string &&
            request.resource.data.mediaType in ['photo', 'video'] &&
            request.resource.data.dateTaken is timestamp &&
            request.resource.data.dateKey is string;
          // Update: only admins (creator check via createdByUid)
          allow update: if isAdmin(familyId);
          // Delete: only admins
          allow delete: if isAdmin(familyId);

          // Comments subcollection (nested under moments)
          match /comments/{commentId} {
            // Read: any family member
            allow read: if isMember(familyId);
            // Create: any family member (append-only)
            allow create: if isMember(familyId) &&
              request.resource.data.text is string &&
              request.resource.data.createdByUid == request.auth.uid;
            // Update: only by creator
            allow update: if isMember(familyId) &&
              resource.data.createdByUid == request.auth.uid;
            // Delete: by creator or admin
            allow delete: if isMember(familyId) &&
              (resource.data.createdByUid == request.auth.uid || isAdmin(familyId));
          }
        }

        // Growth entries subcollection
        match /growth_entries/{entryId} {
          // Read: any family member
          allow read: if isMember(familyId);
          // Create: only admins
          allow create: if isAdmin(familyId) &&
            request.resource.data.date is timestamp &&
            (request.resource.data.weightKg == null || request.resource.data.weightKg is number) &&
            (request.resource.data.heightCm == null || request.resource.data.heightCm is number) &&
            (request.resource.data.headCircumferenceCm == null || request.resource.data.headCircumferenceCm is number);
          // Update: only admins
          allow update: if isAdmin(familyId);
          // Delete: only admins
          allow delete: if isAdmin(familyId);
        }

        // Time capsules subcollection
        match /capsules/{capsuleId} {
          // Read: any family member
          allow read: if isMember(familyId);
          // Create: only admins
          allow create: if isAdmin(familyId) &&
            request.resource.data.title is string &&
            request.resource.data.unlockAt is timestamp &&
            request.resource.data.unlockAt > request.time;
          // Update: only admins
          allow update: if isAdmin(familyId);
          // Delete: only admins
          allow delete: if isAdmin(familyId);
        }
      }
    }
  }
}
